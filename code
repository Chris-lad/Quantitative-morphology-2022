# Loading the packages
library(DESeq2)
library(edgeR)
library(fgsea)
library(qusage)
library(ggplot2)
library(corrplot)
library(vegan)
library(lessR)
library(ggcorrplot)
library(hrbrthemes)
library(devtools)
library(factoextra)
library(FactoMineR)


# Reading the clinical data
clinical.data = read.delim(file='clinical-data.tsv',sep ='\t',header=TRUE)

# Reading the morphological counts
morphological.counts = read.delim(file='morphological-counts.tsv',sep='\t',header=TRUE)

# Reading the RNA-read-counts
RNA.read.counts = read.delim(file='RNA-read-counts.tsv',sep='\t',header=TRUE)

# Reading the gmt file
c2.cp.reactome.v7.5.1.symbols=read.delim('c2.cp.reactome.v7.5.1.symbols.gmt',sep='\t',header=FALSE)

## Creating a vector for each clinical variable
Sex <- clinical.data$SEX
Age <- clinical.data$AGE
Height <- clinical.data$HGHT
Weight <- clinical.data$WGHT
BMI <- clinical.data$BMI
IschemicTime <- clinical.data$TRISCHD
HardyScale <- clinical.data$DTHHRDY
Cohort <- clinical.data$COHORT


## Checking if any NA in vector ---> should Return FALSE
any(is.na(HardyScale))
any(is.na(Cohort))
any(is.na(IschemicTime))
any(is.na(Age))
any(is.na(BMI))
any(is.na(Height))
any(is.na(Weight))
any(is.na(Sex))


#### PART 3

############ PART 3.1: DISTRIBUTION OF THE CLINICAL VARIABLES 

# histogram of the sex distribution
# WE ONLY HAVE MEN IN OUR DATASET

# histogram of the age
hist(Age)
abline(v=mean(Age),col="red",lwd=2)

# histogram of Height
hist(Height)
abline(v=mean(Height),col="red",lwd=2)

# histogram of Weight
hist(Weight)
abline(v=mean(Weight),col="red",lwd=2)

# Histogram of BMI
hist(BMI)
abline(v=mean(BMI),col="red",lwd=2)

# histogram of the Ischemic time
hist(IschemicTime, xlab='Ischemic Time (min)')
abline(v=mean(IschemicTime),col="red",lwd=2)

# Distribution of data according to the HardyScale
hist(HardyScale)
abline(v=mean(HardyScale),col="red",lwd=2)

# THE VISUAL EXPLORATION IS NOT ENOUGH TO CONCLUDE IF SOME VARIABLES ARE 
# NORMALLY DISTRIBUTED OR NOT, a formal normality test is necessary. 

# Shapiro test for Age
shapiro.test(Age)
# Shapiro test for BMI
shapiro.test(BMI)
# Shapiro test for HardyScale
shapiro.test(HardyScale)
# Shapiro test for Height
shapiro.test(Height)
# Shapiro test for IschemicTime
shapiro.test(IschemicTime)
# Shapiro test for Sex
#shapiro.test(Sex) # all 'x' values are identical
# Shapiro test for Weight
shapiro.test(Weight)

## THE SHAPIRO-TEST CONFIRMED THAT NONE OF THE CLINICAL VARIABLE IS 
## NORMALLY DISTRIBUTED AS ALL THE P-VALUES WERE VERY VERY LOW.
## WE CAN NOT ASSUME NORMALITY FOR THIS VARIABLES


## Printing the contingency table of the categorical variables 
##  and  
table(Cohort)
table(HardyScale)



## Creating barplot Hardy Scale
barplot(table(HardyScale), xlab = 'Hardy Scale',
        ylab = 'count', col='blue')


# Creating a barplot of the donor type
barplot(table(Cohort), xlab = 'Type of donor',
        ylab = 'count', col='blue')




############ PART 3.1: Correlations between clinical variables

# Visualization of the relation between variables
#pairs(clinical_data) #--> ain't working bc variables(are not integer)
pairs(~ Age + Height + Weight + BMI + IschemicTime)

# Creating a dataframe containing only the numerical variables. 
num.var <- clinical.data[, c("AGE", "HGHT", "WGHT", "BMI", "TRISCHD")]

# Computation of the Matrix of correlation
correlation = cor(num.var, method = "spearman")
correlation <- round(correlation,2)
print(correlation)


# Correlogram is a graph of correlation matrix

corrplot(correlation, order = 'AOE', addCoef.col = 'black', tl.pos = 'd',
         cl.pos = 'n', col = COL2('PiYG'))

 
# Scatter plot btw Weight and BMI and linear regression line.
plot(BMI, Weight, pch = 16)
abline(lm(Weight ~ BMI), col = "red", lwd = 3)

# Scatter plot btw Weight and Height and linear regression line.
plot(Weight, Height, pch = 16)
abline(lm(Height ~ Weight), col = "red", lwd = 3)

# Scatter plot btw Age and Ischemic time and linear regression line.
plot(IschemicTime, Age, pch = 16)
abline(lm(Age ~ IschemicTime), col = "red", lwd = 3)

# Are there confounding variables ? 
# Verification to detect the possible bias. 



# --> Useless # A basic scatterplot BMI vs Weight with color
#     depending on donor type
ggplot(clinical.data, aes(x=BMI, y=WGHT, color=COHORT)) + 
  geom_point(size=6) +
  theme_ipsum()

## 
# --> Useless  # A basic scatterplot BMI vs Weight with color
#     depending on Hardy scale
ggplot(clinical.data, aes(x=BMI, y=WGHT, color=DTHHRDY)) + 
  geom_point(size=6) +
  theme_ipsum()

# --> Useless # Scatter plot Weight vs Height depending on donor type
ggplot(clinical.data, aes(x=WGHT, y=HGHT, color=COHORT)) + 
  geom_point(size=6) +
  theme_ipsum()

# --> Useless # Scatter plot Weight vs Height depending on Hardy Scale
ggplot(clinical.data, aes(x=WGHT, y=HGHT, color=DTHHRDY)) + 
  geom_point(size=6) +
  theme_ipsum()

# Scatter plot of ischemic time vs Age depending on the cohort
plot(IschemicTime, Age, pch = 16, col=factor(Cohort))


# Legend
legend("bottomright",
       legend = levels(factor(Cohort)),
       pch = 19,
       col = factor(levels(factor(Cohort))))


# Scatter plot of ischemic time vs Age depending on the Hardy Scale.
plot(IschemicTime, Age, pch = 16, col=factor(HardyScale))


# Legend
legend("bottomright",
       legend = levels(factor(HardyScale)),
       pch = 19,
       col = factor(levels(factor(HardyScale))))

## Plotting the scatter plot of correlation between the Age and all 
## the variables in the morphological.count variable. 
morph.num.var = subset(morphological.counts, select = -SMPLID)
cor.mat.clin.morph = cor(num.var, morph.num.var)

# Let us plot the correlation plot
corrplot(cor.mat.clin.morph[,0:9], method='number', addCoef.col = 'black')

corrplot(cor.mat.clin.morph[,0:9], addCoef.col = 'black', tl.pos = 'd',
         cl.pos = 'n')

#PCA analysis
#create a dataset containing only numerical values
num.data <- clinical.data[,-c(1,6,7,9,10,11)]

#pca with printed correlation circle
pca <- PCA(num.data, graph = TRUE)
#print the pca
plot(pca$ind$coord)
#print eigenvalues
print(pca$eig)
#scree plot
fviz_eig(pca, addlabels = TRUE, ylim = c(0, 50))

#print the PCA with coloured Cohort
cohorts <- clinical.data$COHORT
colors <- rep("red",length(cohorts))
colors[cohorts == "Organ Donor (OPO)"] <- "black"
plot(pca$ind$coord,col=colors,pch=19,cex=0.6)
legend("bottomright", legend=c("Organ Donor (OPO)", "Postmortem"),
       col=c("black", "red"), pch=19, cex=0.6)

#print the PCA with coloured hardy scale
hardy <- clinical.data$DTHHRDY
colors <- rep("black",length(hardy))
colors[hardy == 1] <- "red"
colors[hardy == 2] <- "green"
colors[hardy == 3] <- "blue"
colors[hardy == 4] <- "cyan"
plot(pca$ind$coord,col=colors,pch=19,cex=0.6)
legend("bottomright", legend=c("0", "1","2","3","4"),
       col=c("black", "red","green","blue","cyan"), pch=19, cex=0.6)
